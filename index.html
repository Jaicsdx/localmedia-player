<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Online Media Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #0f151d;
      --muted: #8aa0b6;
      --text: #eaf2fb;
      --accent: #4ea1ff;
      --border: #1b2633;
      --shadow: 0 6px 24px rgba(0,0,0,.25);
      --radius: 14px;
      --sidebar-w: 320px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #0b0f14;
      color:var(--text);
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; gap:.75rem;
      padding:.75rem 1rem;
      background: rgba(10,14,19,.7);
      backdrop-filter:saturate(150%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .brand{font-weight:700}
    .grow{flex:1}
    .ham{
      appearance:none; border:0; background:transparent; color:var(--text); cursor:pointer;
      display:grid; place-items:center; width:44px; height:44px; border-radius:10px;
    }
    .ham:hover{background:rgba(255,255,255,.06)}
    .ham svg{width:24px;height:24px}

    /* Layout */
    .wrap{
      display:grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      gap:1rem; padding:1rem;
      transition: grid-template-columns .25s ease;
    }
    /* Collapse on desktop when body has .sidebar-hidden */
    body.sidebar-hidden .wrap{
      grid-template-columns: 0 1fr;
    }

    /* Sidebar */
    .sidebar{
      overflow:auto;
      border:1px solid var(--border);
      background:linear-gradient(180deg,#0e141c,#0a1016);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      max-height:calc(100dvh - 96px);
      transition: transform .25s ease, opacity .2s ease;
    }
    /* Slide-away animation when hidden on desktop */
    body.sidebar-hidden .sidebar{
      transform: translateX(calc(-1 * var(--sidebar-w)));
      opacity:0;
      pointer-events:none;
    }

    .side-head{
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      padding:1rem; border-bottom:1px solid var(--border)
    }
    .side-head h2{margin:0; font-size:1rem}
    .side-body{padding:1rem; display:grid; gap:1rem}
    .section{
      padding:1rem; border:1px dashed var(--border); border-radius:12px; background:rgba(255,255,255,.02)
    }
    .section h3{margin:.2rem 0 .75rem 0; font-size:.95rem}
    .muted{color:var(--muted); font-size:.92rem}
    label{display:block; font-size:.88rem; margin:.35rem 0 .35rem .15rem; color:var(--muted)}
    input[type="text"], input[type="search"], input[type="file"], textarea{
      width:100%; padding:.75rem .85rem; background:#0d131a; color:var(--text);
      border:1px solid var(--border); border-radius:12px; outline:none;
    }
    textarea{resize:vertical; min-height:72px}
    .row{display:flex; gap:.6rem; align-items:center; flex-wrap:wrap}
    .btn{
      appearance:none; border:1px solid var(--border); background:#111821; color:var(--text);
      padding:.7rem 1rem; border-radius:12px; cursor:pointer; font-weight:600
    }
    .btn:hover{border-color:#27374a; background:#121c27}
    .btn.primary{background:linear-gradient(180deg,#1e90ff,#1779da); border-color:#1b6ecf}
    .btn.success{background:linear-gradient(180deg,#34d399,#10b981); border-color:#10b981}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706); border-color:#d97706}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626); border-color:#dc2626}

    /* Main */
    .main{min-width:0; display:grid; grid-template-rows:auto auto 1fr; gap:1rem}
    .tabs{ display:flex; gap:.5rem; flex-wrap:wrap}
    .tab{border:1px solid var(--border); background:#0e141c; color:var(--text);
      padding:.55rem .9rem; border-radius:999px; font-weight:600; cursor:pointer}
    .tab.active{border-color:#2563eb; background:rgba(37,99,235,.15)}

    .player{
      border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; background:#0a1016; box-shadow:var(--shadow)
    }
    .player .p-head{
      display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.75rem 1rem; border-bottom:1px solid var(--border)
    }
    .player .p-body{background:#000}
    video, iframe{width:100%; height:min(70dvh, 640px); display:block; background:#000}

    .gallery{
      display:grid; gap:.75rem;
      grid-template-columns: repeat( auto-fill, minmax(220px, 1fr) );
    }
    .card{
      background:linear-gradient(180deg,#0f151d,#0b1218);
      border:1px solid var(--border); border-radius:14px; overflow:hidden; min-width:0;
      display:flex; flex-direction:column;
    }
    .card h4{margin:.6rem .85rem .1rem .85rem; font-size:1rem; line-height:1.25}
    .card .meta{margin:0 .85rem .7rem .85rem; color:var(--muted); font-size:.86rem}
    .card .cta{display:flex; gap:.5rem; padding:.75rem; border-top:1px solid var(--border); background:#0b1016}
    .card .cta .btn{flex:1}

    /* Mobile drawer behavior */
    @media (max-width: 1024px){
      .wrap{
        grid-template-columns: 1fr;
      }
      .sidebar{
        position: fixed; z-index:60; inset: 64px 0 0 0; width: min(92vw, 380px);
        transform: translateX(-110%);
        opacity:0; pointer-events:none;
      }
      body.sidebar-open .sidebar{
        transform: translateX(0); opacity:1; pointer-events:auto;
      }
      .backdrop{
        position:fixed; z-index:55; inset:64px 0 0 0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:opacity .2s ease;
      }
      body.sidebar-open .backdrop{opacity:1; pointer-events:auto}
      /* On mobile we ignore .sidebar-hidden; we use .sidebar-open to show */
      body.sidebar-hidden .sidebar{transform: translateX(-110%); opacity:0; pointer-events:none;}
    }
  </style>
</head>
<body class="sidebar-hidden"><!-- start hidden by default; remove class if you want it visible -->
  <header>
    <button class="ham" id="hamburger" aria-label="Toggle sidebar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 6h18M3 12h18M3 18h18"/>
      </svg>
    </button>
    <div class="brand">Online Media Player</div>
    <div class="grow"></div>
    <span style="color:var(--muted); font-size:.9rem">Hide/Show left panel with ☰</span>
  </header>

  <div class="wrap">
    <!-- LEFT SIDEBAR (everything here is what gets hidden/shown) -->
    <aside class="sidebar" id="leftSidebar" aria-label="Features panel">
      <div class="side-head">
        <h2>Controls & Library Tools</h2>
        <button class="btn" id="closeSidebar">✕</button>
      </div>
      <div class="side-body">
        <!-- Add / Edit movie -->
        <div class="section">
          <h3>Add movies (Name + OneDrive link) or play local files. JSON is still supported.</h3>
          <div class="row" style="margin-top:.5rem; gap:.8rem">
            <span class="muted">Cloud Library</span>
            <span class="muted">Local Files</span>
          </div>
          <label for="movieTitle">Movie Name</label>
          <input id="movieTitle" type="text" placeholder="e.g., Inception (2010)" autocomplete="off"/>

          <label for="movieLink" style="margin-top:.65rem">OneDrive Link or Embed Code</label>
          <textarea id="movieLink" placeholder="Paste OneDrive embed link or share URL"></textarea>

          <p class="muted" style="margin-top:.35rem">
            Tip: In OneDrive, open the video → <b>Embed</b> → copy the iframe or URL. This app auto-converts most OneDrive links.
          </p>

          <div class="row" style="margin-top:.6rem">
            <button id="addBtn" class="btn primary">Add Movie</button>
            <button id="saveBtn" class="btn success" style="display:none">Save Changes</button>
            <button id="cancelBtn" class="btn">Cancel</button>
          </div>
        </div>

        <!-- Search -->
        <div class="section">
          <h3>Search movies...</h3>
          <input id="searchBox" type="search" placeholder="Search movies..."/>
          <div class="row" style="margin-top:.5rem">
            <button id="clearSearch" class="btn">Clear</button>
          </div>
        </div>

        <!-- Data Management -->
        <div class="section">
          <h3>Data Management</h3>
          <div class="row">
            <button id="downloadJson" class="btn">Download movies.json</button>
            <label class="btn" for="importJsonInput" style="cursor:pointer">Import JSON</label>
            <input id="importJsonInput" type="file" accept="application/json" style="display:none" />
          </div>
          <div class="row" style="margin-top:.5rem">
            <button id="clearAll" class="btn danger">Clear All</button>
          </div>
          <p class="muted" style="margin-top:.6rem" id="sharedNote">
            Using shared <code>movies.json</code> from your site.
          </p>
          <div class="muted" style="margin-top:.5rem">
            <strong>Make it permanent on GitHub Pages:</strong>
            <ol style="margin:.35rem 0 .2rem 1.1rem; padding:0; line-height:1.55">
              <li>Use <em>Download movies.json</em> after adding titles.</li>
              <li>Upload <code>movies.json</code> to your repo (same folder as this HTML).</li>
              <li>Deploy with GitHub Pages. Visitors will load the shared <code>movies.json</code>.</li>
            </ol>
          </div>
        </div>
      </div>
    </aside>

    <!-- Backdrop for mobile -->
    <div class="backdrop" id="backdrop" aria-hidden="true"></div>

    <!-- RIGHT: Main -->
    <main class="main">
      <!-- Tabs / actions -->
      <div class="tabs" role="tablist" aria-label="Content sources">
        <button class="tab active" id="tabCloud" role="tab" aria-selected="true">Cloud Library</button>
        <button class="tab" id="tabLocal" role="tab" aria-selected="false">Local Files</button>
      </div>

      <!-- Quick search (optional) -->
      <div class="row">
        <input id="searchBoxTop" type="search" style="flex:1" placeholder="Search movies..." />
        <button id="clearSearchTop" class="btn">Clear</button>
      </div>

      <!-- Player -->
      <section class="player" aria-label="Player">
        <div class="p-head">
          <strong id="nowPlaying">Select a movie to play</strong>
          <div class="row">
            <button class="btn" id="editSelected" style="display:none" title="Edit currently selected">Edit</button>
            <button class="btn warn" id="removeSelected" style="display:none" title="Remove from library">Remove</button>
          </div>
        </div>
        <div class="p-body">
          <video id="video" controls preload="metadata" style="display:none"></video>
          <iframe id="iframe" allowfullscreen style="display:none" loading="lazy" referrerpolicy="no-referrer"></iframe>
        </div>
      </section>

      <!-- Cloud Library gallery -->
      <section id="cloudView" aria-label="Cloud Library">
        <div class="gallery" id="cloudGallery"></div>
      </section>

      <!-- Local files view -->
      <section id="localView" aria-label="Local Files" style="display:none">
        <div class="section" style="margin-bottom:1rem">
          <h3>Local Files</h3>
          <input id="localPicker" type="file" accept="video/*" multiple />
          <p class="muted" style="margin-top:.4rem">Local files never leave your device.</p>
        </div>
        <div class="gallery" id="localGallery"></div>
      </section>
    </main>
  </div>

  <script>
    ;(()=>{
      const $ = s => document.querySelector(s);
      const el = (t,a={},c=[])=>{const n=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k==='class')n.className=v;else if(k==='dataset')Object.assign(n.dataset,v);else if(k.startsWith('on')&&typeof v==='function')n.addEventListener(k.slice(2),v);else n.setAttribute(k,v)};if(typeof c==='string')n.textContent=c;else c.forEach(x=>n.appendChild(x));return n};
      const uid=()=>Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4);

      const state = { movies:[], selectedId:null, localFiles:[], usingSharedJson:false, editingId:null };
      const persistKey="omp.movies.v2";

      // Sidebar toggle (the only thing you asked for)
      const body = document.body;
      const isMobile = ()=> window.matchMedia('(max-width:1024px)').matches;
      function toggleSidebar(){
        if(isMobile()){
          // mobile = use .sidebar-open class to slide panel in/out
          if(body.classList.contains('sidebar-open')) body.classList.remove('sidebar-open');
          else body.classList.add('sidebar-open');
        }else{
          // desktop = collapse/expand with .sidebar-hidden
          body.classList.toggle('sidebar-hidden');
        }
      }
      function closeSidebar(){
        body.classList.remove('sidebar-open');
        // on desktop, keep collapsed if already hidden
      }

      // OneDrive helpers (kept same)
      function extractIframeSrc(html){const m=String(html||'').match(/<iframe[^>]+src=["']([^"']+)["']/i);return m?m[1]:null}
      function isProbablyVideoUrl(u){return /\.(mp4|webm|m4v|mov|mkv)(\?|#|$)/i.test(u)}
      function looksLikeOneDrive(u){try{const x=new URL(u);return /onedrive\.live\.com$/.test(x.hostname)||/1drv\.ms$/.test(x.hostname)}catch(e){return false}}
      function toOneDriveEmbed(u){try{const url=new URL(u);const resid=url.searchParams.get('resid');const authkey=url.searchParams.get('authkey');if(resid){const base=`https://onedrive.live.com/embed?resid=${encodeURIComponent(resid)}&em=2`;return authkey?`${base}&authkey=${encodeURIComponent(authkey)}`:base}return u}catch(e){return u}}
      function normalizeLink(raw){
        const trimmed=String(raw||'').trim(); if(!trimmed) return null;
        const iframeSrc=extractIframeSrc(trimmed); if(iframeSrc) return {kind:'iframe',url:iframeSrc};
        if(isProbablyVideoUrl(trimmed)) return {kind:'video',url:trimmed};
        if(looksLikeOneDrive(trimmed)) return {kind:'iframe',url:toOneDriveEmbed(trimmed)};
        return {kind:'iframe',url:trimmed};
      }

      // Storage
      function loadLocal(){try{const raw=localStorage.getItem(persistKey);if(!raw)return null;const arr=JSON.parse(raw);return Array.isArray(arr)?arr:null}catch(e){return null}}
      function saveLocal(){try{localStorage.setItem(persistKey,JSON.stringify(state.movies))}catch(e){}}

      // Elements
      const videoEl=$("#video"), iframeEl=$("#iframe"), nowPlaying=$("#nowPlaying");
      const gallery=$("#cloudGallery"), localGallery=$("#localGallery");

      function cardForMovie(m){
        const play = el('button',{class:'btn primary', onclick:()=>selectMovie(m.id)},['Play']);
        const edit = el('button',{class:'btn', onclick:()=>beginEdit(m.id)},['Edit']);
        const del  = el('button',{class:'btn warn', onclick:()=>removeMovie(m.id)},['Delete']);
        return el('div',{class:'card', dataset:{id:m.id}},[
          el('h4',{},[document.createTextNode(m.title||'Untitled')]),
          el('p',{class:'meta'},[document.createTextNode(m.kind==='video'?'Direct video':'OneDrive / iframe')]),
          el('div',{class:'cta'},[play, edit, del])
        ]);
      }
      function renderCloud(term=''){
        gallery.innerHTML='';
        const q=String(term||'').toLowerCase();
        const list=q?state.movies.filter(m=>(m.title||'').toLowerCase().includes(q)):state.movies.slice();
        if(!list.length){
          gallery.appendChild(el('div',{class:'section muted'},['No movies yet. Open ☰ and add some.']));
          return;
        }
        list.forEach(m=>gallery.appendChild(cardForMovie(m)));
      }
      function renderLocal(){
        localGallery.innerHTML='';
        if(!state.localFiles.length){
          localGallery.appendChild(el('div',{class:'section muted'},['Pick local video files to list them here.']));
          return;
        }
        for(const f of state.localFiles){
          const btn=el('button',{class:'btn primary', onclick:()=>playLocal(f)},['Play']);
          localGallery.appendChild(el('div',{class:'card'},[
            el('h4',{},[document.createTextNode(f.name)]),
            el('p',{class:'meta'},[`Local file — ${(f.size/1_000_000).toFixed(1)} MB`]),
            el('div',{class:'cta'},[btn])
          ]));
        }
      }
      function setPlayer(kind,url,title=''){
        videoEl.pause(); videoEl.removeAttribute('src'); videoEl.style.display='none';
        iframeEl.removeAttribute('src'); iframeEl.style.display='none';
        if(kind==='video'){ videoEl.style.display=''; videoEl.src=url; nowPlaying.textContent=`Now playing: ${title}`; setTimeout(()=>videoEl.play().catch(()=>{}),50); }
        else { iframeEl.style.display=''; iframeEl.src=url; nowPlaying.textContent=`Now playing (iframe): ${title}`; }
        $("#editSelected").style.display = state.selectedId ? '' : 'none';
        $("#removeSelected").style.display = state.selectedId ? '' : 'none';
      }
      function selectMovie(id){ const m=state.movies.find(x=>x.id===id); if(!m) return; state.selectedId=id; setPlayer(m.kind,m.url,m.title); }
      function beginEdit(id){ const m=state.movies.find(x=>x.id===id); if(!m) return;
        state.editingId=id; $("#movieTitle").value=m.title||''; $("#movieLink").value=m.original||m.url||'';
        $("#saveBtn").style.display=''; openSidebar();
      }
      function addMovie(){
        const title=$("#movieTitle").value.trim(); const raw=$("#movieLink").value.trim();
        if(!title||!raw) return alert("Enter both Movie Name and OneDrive link/embed.");
        const norm=normalizeLink(raw); if(!norm) return alert("Could not understand that link.");
        state.movies.unshift({id:uid(),title,url:norm.url,kind:norm.kind,original:raw,addedAt:Date.now()});
        saveLocal(); renderCloud($("#searchBox").value||$("#searchBoxTop").value);
      }
      function saveChanges(){
        const id=state.editingId; if(!id) return;
        const title=$("#movieTitle").value.trim(); const raw=$("#movieLink").value.trim();
        if(!title||!raw) return alert("Enter both Movie Name and OneDrive link/embed.");
        const norm=normalizeLink(raw); if(!norm) return alert("Could not understand that link.");
        const i=state.movies.findIndex(x=>x.id===id);
        if(i>=0){ state.movies[i]={...state.movies[i],title,url:norm.url,kind:norm.kind,original:raw,updatedAt:Date.now()};
          saveLocal(); renderCloud($("#searchBox").value||$("#searchBoxTop").value);
          if(state.selectedId===id) setPlayer(norm.kind,norm.url,title);
        }
      }
      function removeMovie(id){
        if(!confirm("Remove this movie from your Cloud Library?")) return;
        const i=state.movies.findIndex(x=>x.id===id);
        if(i>=0){ state.movies.splice(i,1); if(state.selectedId===id){state.selectedId=null; nowPlaying.textContent="Select a movie to play"; setPlayer('video','');}
          saveLocal(); renderCloud($("#searchBox").value||$("#searchBoxTop").value);
        }
      }
      function playLocal(f){ const url=URL.createObjectURL(f); state.selectedId=null; setPlayer('video',url,f.name); }

      // Import/Export
      function downloadJson(){
        const data=JSON.stringify(state.movies,null,2);
        const blob=new Blob([data],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='movies.json';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
      }
      function importJson(file){
        const reader=new FileReader();
        reader.onload=()=>{
          try{
            const arr=JSON.parse(reader.result); if(!Array.isArray(arr)) throw new Error("Not an array");
            state.movies=arr.map(x=>({id:x.id||uid(),title:String(x.title||'Untitled'),url:String(x.url||''),kind:x.kind==='video'?'video':'iframe',original:x.original||x.url||''}));
            saveLocal(); renderCloud($("#searchBox").value||$("#searchBoxTop").value); alert("Imported movies.json successfully.");
          }catch(e){ alert("Failed to import: "+e.message); }
        };
        reader.readAsText(file);
      }
      function clearAll(){
        if(!confirm("Clear your local Cloud Library?")) return;
        state.movies=[]; saveLocal(); renderCloud(); state.selectedId=null; nowPlaying.textContent="Select a movie to play"; setPlayer('video','');
      }

      // Search sync
      function syncSearch(val){ $("#searchBox").value=val; $("#searchBoxTop").value=val; renderCloud(val); }

      // Init
      async function init(){
        try{
          const res=await fetch('./movies.json',{cache:'no-store'});
          if(res.ok){ const arr=await res.json(); if(Array.isArray(arr)){
            state.movies=arr.map(x=>({id:x.id||uid(),title:String(x.title||'Untitled'),url:String(x.url||''),kind:x.kind==='video'?'video':'iframe',original:x.original||x.url||''}));
            state.usingSharedJson=true;
          }}
        }catch(e){}
        if(!state.movies.length){ const local=loadLocal(); if(local&&local.length){state.movies=local; state.usingSharedJson=false;} }
        $("#sharedNote").textContent = state.usingSharedJson ? 'Using shared movies.json from your site.' : 'No shared movies.json detected — using your browser storage.';
        renderCloud(); renderLocal();
      }

      // Wire up
      $("#hamburger").addEventListener('click', toggleSidebar);
      $("#closeSidebar").addEventListener('click', closeSidebar);
      $("#backdrop")?.addEventListener('click', closeSidebar);
      window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeSidebar(); });

      // Tabs
      $("#tabCloud").addEventListener('click', ()=>{ $("#tabCloud").classList.add('active'); $("#tabLocal").classList.remove('active'); $("#cloudView").style.display=''; $("#localView").style.display='none'; });
      $("#tabLocal").addEventListener('click', ()=>{ $("#tabLocal").classList.add('active'); $("#tabCloud").classList.remove('active'); $("#cloudView").style.display='none'; $("#localView").style.display=''; });

      // Add/Edit
      $("#addBtn").addEventListener('click', addMovie);
      $("#saveBtn").addEventListener('click', saveChanges);
      $("#cancelBtn").addEventListener('click', ()=>{ $("#movieTitle").value=''; $("#movieLink").value=''; });

      // Import/Export
      $("#downloadJson").addEventListener('click', downloadJson);
      $("#importJsonInput").addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) importJson(f); e.target.value=''; });
      $("#clearAll").addEventListener('click', clearAll);

      // Search
      $("#searchBox").addEventListener('input', e=>syncSearch(e.target.value));
      $("#searchBoxTop").addEventListener('input', e=>syncSearch(e.target.value));
      $("#clearSearch").addEventListener('click', ()=>syncSearch(''));
      $("#clearSearchTop").addEventListener('click', ()=>syncSearch(''));

      // Local files
      $("#localPicker").addEventListener('change', e=>{ state.localFiles=Array.from(e.target.files||[]); renderLocal(); });

      init();
    })();
  </script>
</body>
</html>
